<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — License Generator (Login required)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220; --card:#071425; --muted:#9fb2d0; --accent:#60a5fa;
    --radius:12px; --glass: rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#051028,#071425);
    color:#eaf6ff; padding:28px; display:flex; justify-content:center;
  }
  .wrap{width:100%; max-width:980px}
  header{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px}
  .brand{display:flex; gap:12px; align-items:center; color:inherit; text-decoration:none}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#60a5fa,#5eead4);display:grid;place-items:center;font-weight:700;color:#012}
  h1{margin:0; font-size:20px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:18px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.03)}
  .grid{display:grid; gap:14px; margin-top:14px}
  @media(min-width:860px){ .grid{grid-template-columns: 1fr 360px} }

  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  input, select, button { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit; }
  input::placeholder{color:rgba(255,255,255,0.35)}
  .row{display:flex; gap:10px}
  .row > *{flex:1}
  .small{font-size:13px; color:var(--muted)}
  .table{width:100%; margin-top:12px; border-collapse:collapse}
  .table th, .table td{padding:8px 10px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.02); font-size:13px}
  .btn { display:inline-flex; gap:8px; align-items:center; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; border:none }
  .btn-primary{ background:linear-gradient(90deg,#5eead4,#60a5fa); color:#022; }
  .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted) }
  .muted{color:var(--muted)}
  .note{font-size:13px; color:var(--muted); margin-top:8px}
  .danger{color:#ff8b8b}
  .ok{color:#bfffdc}
  footer{margin-top:18px; color:var(--muted); font-size:13px}

  /* login modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(2,6,12,0.6); display:flex; align-items:center; justify-content:center; z-index:9999;
  }
  .modal{width:100%; max-width:420px; background:linear-gradient(180deg, rgba(255,255,255,0.03), transparent); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); text-align:left}
  .modal h3{margin:0 0 10px 0}
  .muted-block{color:var(--muted); font-size:13px; margin-bottom:8px}
  .logout{cursor:pointer; text-decoration:underline; font-size:13px; color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="brand" href="index.html"><div class="logo">IA</div><div><div style="font-weight:700">Interview Assistant</div><div class="small muted">Admin — License Generator</div></div></a>
      <div style="text-align:right">
        <div class="small muted">This page requires admin login on every access</div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Generate licenses</h2>

        <div id="controls">
          <label>Username</label>
          <input id="username" placeholder="e.g. alice@example.com">

          <div style="height:8px"></div>

          <label>Hours valid</label>
          <input id="hours" type="number" min="1" value="2">

          <div style="height:8px"></div>

          <div class="row" style="margin-top:8px;">
            <button id="btnGenerate" class="btn btn-primary">Generate license</button>
            <button id="btnClear" class="btn btn-ghost">Clear</button>
          </div>

          <div id="message" class="note"></div>

          <table class="table" id="licensesTable" style="display:none; margin-top:12px">
            <thead><tr><th>Username</th><th>Password</th><th>Expiry (UTC)</th><th>Actions</th></tr></thead>
            <tbody id="licensesBody"></tbody>
          </table>

          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btnDownloadAll" class="btn btn-primary">Download licenses.json</button>
            <button id="btnCopyAll" class="btn btn-ghost">Copy JSON</button>
            <button id="btnClearAll" class="btn btn-ghost">Clear all</button>
            <button id="btnLogout" class="btn btn-ghost" title="End session">Logout</button>
          </div>

          <div class="note" style="margin-top:10px">
            Each license is a JSON object `{ "username": "...", "password": "...", "expiry": "ISO" }`. Host `licenses.json` privately (raw GitHub is public).
          </div>
        </div>
      </div>

      <aside class="card" style="display:none"></aside>
    </div>

    <footer>
      <div class="small muted">© <span id="year"></span> Interview Assistant — Admin</div>
    </footer>
  </div>

  <div id="loginModal" class="modal-backdrop" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h3 id="loginTitle">Admin login required</h3>
      <div class="muted-block">Enter the admin password from <code>admin.json</code>. This is required on every page load. The file is loaded into memory only.</div>
      <label for="loginPass">Password</label>
      <input id="loginPass" type="password" placeholder="Admin password">
      <div style="height:10px"></div>
      <div class="row">
        <button id="btnLogin" class="btn btn-primary">Log in</button>
        <button id="btnReloadAdmin" class="btn btn-ghost">Reload admin.json</button>
      </div>
      <div id="loginMsg" class="note" style="margin-top:8px"></div>
    </div>
  </div>

<script>
(() => {
  const yearEl = document.getElementById('year'); yearEl.textContent = new Date().getFullYear();

  // storage keys
  const LS_LICENSES = 'ia_licenses_v1';

  // elements
  const usernameEl = document.getElementById('username');
  const hoursEl = document.getElementById('hours');
  const btnGenerate = document.getElementById('btnGenerate');
  const btnClear = document.getElementById('btnClear');
  const btnDownloadAll = document.getElementById('btnDownloadAll');
  const btnCopyAll = document.getElementById('btnCopyAll');
  const btnClearAll = document.getElementById('btnClearAll');
  const btnLogout = document.getElementById('btnLogout');
  const message = document.getElementById('message');

  const licensesTable = document.getElementById('licensesTable');
  const licensesBody = document.getElementById('licensesBody');

  const loginModal = document.getElementById('loginModal');
  const loginPass = document.getElementById('loginPass');
  const btnLogin = document.getElementById('btnLogin');
  const btnReloadAdmin = document.getElementById('btnReloadAdmin');
  const loginMsg = document.getElementById('loginMsg');

  // in-memory admin data (never persisted by us intentionally)
  // supported shapes: { admin_password: "...", pat: "github_pat_...", repo: "owner/repo", branch: "master" }
  let adminData = null;
  let adminPrimaryPassword = null; // extracted
  // --- START HARDCODED MODIFICATION ---
  // 1. SET YOUR ACTUAL PAT and REPO HERE
  //    REPLACE "YOUR_ACTUAL_PAT_HERE" AND "YOUR_OWNER/YOUR_REPO"
  let adminPAT = "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";
  let adminRepo = 'olamicreas/interview'; // e.g. 'my-user/interview-licenses'
  let adminBranch = 'main';                // Optional: Hardcode your branch (e.g., 'main' or 'master')
  // --- END HARDCODED MODIFICATION ---

  function tryExtractPassword(obj) {
    if (!obj || typeof obj !== 'object') return null;
    if (typeof obj.admin_password === 'string') return obj.admin_password;
    if (typeof obj.password === 'string') return obj.password;
    if (Array.isArray(obj.admins) && obj.admins.length && typeof obj.admins[0].password === 'string') return obj.admins[0].password;
    // fallback: first string property
    for (const k of Object.keys(obj)) {
      if (typeof obj[k] === 'string' && /pass|pwd|password/i.test(k)) return obj[k];
    }
    return null;
  }
  function tryExtractPAT(obj) {
    if (!obj || typeof obj !== 'object') return null;
    if (typeof obj.pat === 'string' && obj.pat.trim()) return obj.pat.trim();
    if (typeof obj.token === 'string' && obj.token.trim()) return obj.token.trim();
    // fallback search
    for (const k of Object.keys(obj)) {
      if (typeof obj[k] === 'string' && obj[k].startsWith('github_pat_')) return obj[k];
    }
    return null;
  }
  function tryExtractRepo(obj) {
    if (!obj || typeof obj !== 'object') return null;
    if (typeof obj.repo === 'string' && obj.repo.includes('/')) return obj.repo.trim();
    return null;
  }
  function tryExtractBranch(obj) {
    if (!obj || typeof obj !== 'object') return null;
    if (typeof obj.branch === 'string' && obj.branch.trim()) return obj.branch.trim();
    return null;
  }

  async function fetchAdminJson(url = './admin.json') {
    loginMsg.textContent = `Loading admin.json from: ${url}`;
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      const pw = tryExtractPassword(j);
      // NOTE: PAT extraction logic is now ignored to rely on the hardcoded value.
      // const pat = tryExtractPAT(j); 
      const repo = tryExtractRepo(j);
      const branch = tryExtractBranch(j);
      if (!pw) throw new Error('No admin password found in JSON');
      adminData = j;
      adminPrimaryPassword = pw;
      // --- START MODIFICATION ---
      // ONLY update PAT/Branch/Repo if they were NOT already hardcoded (optional safety)
      // We skip adminPAT = pat || null; to keep the hardcoded value.
      if (!adminBranch && branch) adminBranch = branch;
      if (repo) adminRepo = repo; // Allow admin.json to override hardcoded repo
      // --- END MODIFICATION ---
      loginMsg.textContent = `admin.json loaded from ${url}. PAT is hardcoded.`;
      loginMsg.className = 'note ok';
      return true;
    } catch (err) {
      adminData = null; adminPrimaryPassword = null; 
      // NOTE: adminPAT, adminRepo, adminBranch are left as the hardcoded values.
      loginMsg.textContent = `Failed to load admin.json from ${url}: ${err.message}. PAT is hardcoded.`;
      loginMsg.className = 'note danger';
      return false;
    }
  }

  // GitHub API helpers
  const GITHUB_API_BASE = 'https://api.github.com';

  async function githubRequest(path, options = {}) {
    // Build headers & options
    const headers = Object.assign({}, options.headers || {});
    headers['Accept'] = headers['Accept'] || 'application/vnd.github+json';
    if (adminPAT) {
      headers['Authorization'] = `token ${adminPAT}`;
    }
    const res = await fetch(`${GITHUB_API_BASE}${path}`, Object.assign({}, options, { headers }));
    // parse body (attempt json)
    let bodyText;
    try { bodyText = await res.text(); } catch (e) { bodyText = ''; }
    let bodyJson = null;
    try { bodyJson = bodyText ? JSON.parse(bodyText) : null; } catch (e) { bodyJson = null; }
    return { status: res.status, ok: res.ok, json: bodyJson, text: bodyText, res };
  }

  async function detectBranch(owner, repo) {
    // If adminBranch configured, trust it
    if (adminBranch) return adminBranch;
    // Try 'master' then 'main'
    const candidates = ['master', 'main'];
    for (const b of candidates) {
      // Use the contents API to check for file existence
      const path = `/repos/${owner}/${repo}/contents/licenses.json?ref=${encodeURIComponent(b)}`;
      try {
        const r = await githubRequest(path, { method: 'GET' });
        if (r.status === 200) {
          return b;
        }
      } catch (e) {
        // ignore
      }
    }
    return null;
  }

  async function getFileInfo(owner, repo, path, branch = null) {
    const ref = branch ? `?ref=${encodeURIComponent(branch)}` : '';
    const apiPath = `/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}${ref}`;
    const r = await githubRequest(apiPath, { method: 'GET' });
    if (r.status === 200 && r.json) return r.json;
    // when 404 return null, when 401/403 throw for the caller to handle
    if (r.status === 404) return null;
    const err = new Error(`GitHub GET failed: ${r.status}`);
    err.info = r.json || r.text;
    err.status = r.status;
    throw err;
  }

  async function uploadFileToGitHub(owner, repo, path, contentBase64, commitMessage, sha = null, branch = null) {
    const apiPath = `/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const body = { message: commitMessage, content: contentBase64 };
    if (sha) body.sha = sha;
    if (branch) body.branch = branch;
    const r = await githubRequest(apiPath, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    if (!r.ok) {
      const err = new Error('GitHub upload failed: ' + (r.text || JSON.stringify(r.json)));
      err.info = r.json || r.text;
      err.status = r.status;
      throw err;
    }
    return r.json;
  }

  // Fetch licenses.json raw (same origin or raw.githubusercontent.com)
  async function fetchLicensesJson(url = './licenses.json') {
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      // accept both {licenses: []} or [] directly
      const arr = Array.isArray(j) ? j : (Array.isArray(j.licenses) ? j.licenses : []);
      if (arr.length) localStorage.setItem(LS_LICENSES, JSON.stringify(arr));
      return arr;
    } catch (err) {
      console.warn(`Failed to load licenses.json: ${err.message}`);
      // fallback to localStorage
      return loadLicenses();
    }
  }

  // try automatic fetch of admin.json and licenses.json
  (async ()=>{
    let ok = await fetchAdminJson('./admin.json');
    if (!ok) {
      await fetchAdminJson('admin.json');
    }
    
    // --- START MODIFICATION ---
    // Initialize licenses from licenses.json (prioritize repo raw if PAT and repo are set, which they now are hardcoded)
    if (adminPAT && adminRepo) {
      // construct raw URL if adminRepo is in owner/repo form
      try {
        const [owner, repo] = adminRepo.split('/');
        // Use hardcoded branch if available, otherwise detect
        const branch = adminBranch || (await detectBranch(owner, repo)); 
        if (branch) {
          const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/licenses.json`;
          await fetchLicensesJson(rawUrl);
          adminBranch = branch; // Update branch if it was detected
        } else {
          // fallback to local path
          await fetchLicensesJson();
        }
      } catch (e) {
        await fetchLicensesJson();
      }
    } else {
      await fetchLicensesJson();
    }
    // --- END MODIFICATION ---
    
    // Show the login modal
    showLoginModal();
  })();

  // login modal control
  function showLoginModal() {
    loginPass.value = '';
    loginMsg.textContent = '';
    loginModal.style.display = 'flex';
    loginModal.setAttribute('aria-hidden','false');
    loginPass.focus();
  }
  function hideLoginModal() {
    loginModal.style.display = 'none';
    loginModal.setAttribute('aria-hidden','true');
  }

  btnLogin.addEventListener('click', ()=>{
    const entered = (loginPass.value || '').trim();
    if (!adminPrimaryPassword) {
      loginMsg.textContent = 'No admin.json loaded. Please ensure admin.json is available.';
      return;
    }
    if (!entered) {
      loginMsg.textContent = 'Enter admin password.';
      return;
    }
    if (entered === adminPrimaryPassword) {
      hideLoginModal();
      loginPass.value = '';
      loginMsg.textContent = '';
      message.textContent = 'Logged in for this page visit. (You will be prompted again next time.)';
      message.className = 'note ok';
      renderLicenses();
    } else {
      loginMsg.textContent = 'Incorrect password.';
      loginMsg.className = 'note danger';
      loginPass.value = '';
      loginPass.focus();
    }
  });

  btnReloadAdmin.addEventListener('click', async ()=>{
    // re-fetch admin.json
    const ok = await fetchAdminJson('./admin.json') || await fetchAdminJson('admin.json');
    if (ok) loginMsg.textContent = 'admin.json reloaded, enter password';
  });

  // license helpers
  function loadLicenses(){
    try{
      const raw = localStorage.getItem(LS_LICENSES);
      if(!raw) return [];
      return JSON.parse(raw);
    }catch(e){
      return [];
    }
  }

  // Main saveLicenses: upload to GitHub if PAT + repo available, else fallback to localStorage only.
  async function saveLicenses(arr){
    // write to localStorage first for UI consistency (will be overwritten by remote if succeeded)
    localStorage.setItem(LS_LICENSES, JSON.stringify(arr));
    renderLicenses();

    // If we have a PAT and a repo, attempt to push to GitHub automatically
    if (!adminPAT || !adminRepo) {
      // Since PAT/Repo are hardcoded, this condition should only trigger if they are empty strings.
      message.textContent = 'Hardcoded PAT or Repo is missing — saved locally only.';
      message.className = 'note';
      return;
    }

    // Build object structure to write (array wrapped in { licenses: [...] } -- match your repo)
    const payload = { licenses: arr };

    // Prepare Base64 content (utf8-safe)
    const contentStr = JSON.stringify(payload, null, 2);
    const utf8bytes = new TextEncoder().encode(contentStr);
    const contentBase64 = btoa(String.fromCharCode(...utf8bytes)); // works for short payloads

    // parse owner/repo
    const [owner, repo] = adminRepo.split('/');
    if (!owner || !repo) {
      message.textContent = 'Invalid hardcoded repo format (must be owner/repo).';
      message.className = 'note danger';
      return;
    }

    // detect branch if not set
    if (!adminBranch) {
      try {
        adminBranch = await detectBranch(owner, repo);
      } catch (e) {
        adminBranch = null;
      }
    }

    try {
      message.textContent = 'Uploading licenses.json to GitHub...';
      message.className = 'note';

      // Get existing file info (sha) if it exists
      let fileInfo = null;
      try {
        fileInfo = await getFileInfo(owner, repo, 'licenses.json', adminBranch);
      } catch (err) {
        // If 401 or 403, surface message and stop
        if (err && err.status) {
          if (err.status === 401) {
            throw new Error('GitHub token check failed 401: Bad credentials. Ensure PAT is valid.');
          }
          if (err.status === 403) {
            throw new Error('GitHub upload failed: Resource not accessible by personal access token (403). Ensure PAT has "contents" permission and push access.');
          }
        }
        // other errors: continue to attempt create
      }

      const sha = fileInfo ? fileInfo.sha : null;

      // commit message
      const commitMessage = sha ? 'Update licenses.json via admin UI' : 'Create licenses.json via admin UI';

      const uploadResp = await uploadFileToGitHub(owner, repo, 'licenses.json', contentBase64, commitMessage, sha, adminBranch);
      // uploadResp contains the API response on success
      message.textContent = 'Uploaded licenses.json to GitHub ✓';
      message.className = 'note ok';
      // refresh local copy (raw URL) if possible
      try {
        if (adminBranch) {
          const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${adminBranch}/licenses.json?timestamp=${Date.now()}`;
          await fetchLicensesJson(rawUrl);
        } else {
          await fetchLicensesJson();
        }
      } catch (e) { /* ignore refresh errors */ }
    } catch (err) {
      console.error('GitHub upload error:', err);
      // Provide helpful text from the GitHub error if available
      let infoMsg = err.message || 'Upload failed';
      if (err.info && typeof err.info === 'object' && err.info.message) {
        infoMsg = `${err.info.message}`;
      }
      message.textContent = `Generated but failed to push to GitHub: ${infoMsg}`;
      message.className = 'note danger';
    }
  }

  function renderLicenses(){
    // don't show licenses if not logged in (modal visible)
    if (loginModal.style.display !== 'none') return;
    const licenses = loadLicenses();
    licensesBody.innerHTML = '';
    if(licenses.length === 0){
      licensesTable.style.display = 'none';
      return;
    }
    licensesTable.style.display = '';
    licenses.forEach((lic, idx) => {
      const tr = document.createElement('tr');
      const tdUser = document.createElement('td'); tdUser.textContent = lic.username;
      const tdPass = document.createElement('td'); tdPass.textContent = lic.password;
      const tdExp = document.createElement('td'); tdExp.textContent = lic.expiry;
      const tdAct = document.createElement('td');
      const btnRemove = document.createElement('button');
      btnRemove.className = 'btn btn-ghost';
      btnRemove.textContent = 'Remove';
      btnRemove.onclick = async () => {
        if (!confirm('Remove this license?')) return;
        const arr = loadLicenses(); arr.splice(idx,1);
        await saveLicenses(arr);
      };
      tdAct.appendChild(btnRemove);
      tr.appendChild(tdUser); tr.appendChild(tdPass); tr.appendChild(tdExp); tr.appendChild(tdAct);
      licensesBody.appendChild(tr);
    });
  }

  // password generator
  function makePassword(){ return Math.random().toString(36).slice(2, 12); }

  // Generate license (only allowed if logged in)
  btnGenerate.addEventListener('click', async ()=>{
    if (loginModal.style.display !== 'none') { alert('Please login first'); return; }
    const username = usernameEl.value.trim();
    const hours = Number(hoursEl.value) || 0;
    if(!username) return alert('Enter username');
    if(!hours || hours <= 0) return alert('Enter hours > 0');
    const expiry = new Date(Date.now() + hours * 60 * 60 * 1000).toISOString();
    const password = makePassword();
    const license = { username, password, expiry };
    // Load existing licenses from localStorage or licenses.json
    const arr = loadLicenses();
    arr.push(license);
    await saveLicenses(arr);
    usernameEl.value = '';
    message.textContent = `License generated for ${license.username} (expires ${expiry}) and attempt made to save to licenses.json`;
    message.className = 'note ok';
  });

  btnClear.addEventListener('click', ()=>{ usernameEl.value=''; hoursEl.value='2'; message.textContent=''; });

  btnClearAll.addEventListener('click', async ()=>{
    if (loginModal.style.display !== 'none') { alert('Please login first'); return; }
    if(!confirm('Clear all licenses? This cannot be undone.')) return;
    await saveLicenses([]);
    message.textContent = 'All licenses cleared and attempt made to save to licenses.json';
    message.className = 'note';
  });

  btnDownloadAll.addEventListener('click', ()=>{
    if (loginModal.style.display !== 'none') { alert('Please login first'); return; }
    const obj = { licenses: loadLicenses() };
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'licenses.json'; a.click();
    message.textContent = 'licenses.json downloaded (local copy)';
    message.className = 'note';
  });

  btnCopyAll.addEventListener('click', async ()=>{
    if (loginModal.style.display !== 'none') { alert('Please login first'); return; }
    const txt = JSON.stringify({ licenses: loadLicenses() }, null, 2);
    try{ await navigator.clipboard.writeText(txt); message.textContent = 'licenses.json copied to clipboard'; message.className = 'note'; }
    catch(e){ alert('Clipboard not available. Use download instead.'); }
  });

  btnLogout.addEventListener('click', ()=>{
    // "logout" — require login again on next action / page interaction
    showLoginModal();
    message.textContent = 'Logged out — you will need to log in again.';
    message.className = 'note';
  });

  // When Enter pressed in password field, attempt login
  loginPass.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') btnLogin.click(); });

  // initial render
  renderLicenses();
})();
</script>
</body>
</html>

